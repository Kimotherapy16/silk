<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Silk | Manual POS</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #121212;
      color: white;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .navbar {
      background-color: #1f1f1f;
    }
    .navbar-brand {
      color: #00bcd4;
      font-weight: bold;
    }
    .navbar-brand:hover {
      color: #00acc1;
    }
    .nav-link {
      color: white;
    }
    .nav-link:hover {
      color: #00bcd4;
    }
    .form-control, .form-select {
      background-color: #2b2b2b;
      color: white;
      border: none;
    }
    .form-control:focus, .form-select:focus {
      border-color: #00bcd4;
      box-shadow: 0 0 0 0.2rem rgba(0,188,212,0.25);
    }
    .card {
      background-color: #1f1f1f;
      border: none;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    .btn-custom {
      background-color: #00bcd4; /* Silk Blue */
      color: #121212;
      border: none;
    }
    .btn-custom:hover {
      background-color: #00acc1; /* Silk Blue lighter */
    }
    .btn-danger {
      background-color: #f44336;
    }
    .btn-danger:hover {
      background-color: #e53935;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark px-3">
    <a class="navbar-brand" href="seller-dashboard.html">Silk</a>
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="seller-dashboard.html">Home</a></li>
        <li class="nav-item"><a class="nav-link" href="add-product.html">Add Products</a></li>
        <li class="nav-item"><a class="nav-link" href="product.html">My Products</a></li>
        <li class="nav-item"><a class="nav-link" href="orders.html">Orders</a></li>
        <li class="nav-item"><a class="nav-link" href="pos.html">Manual POS</a></li>
        <li class="nav-item"><a class="nav-link" href="profile.html">Profile</a></li>
        <li class="nav-item"><a class="nav-link" href="index.html">Logout</a></li>
      </ul>
    </div>
  </nav>

  <div class="container py-4">
    <h2 class="mb-4">Manual POS</h2>
    <div class="row g-4">
      <div class="col-md-6">
        <div class="card p-3">
          <h5>Select Product</h5>
          <select class="form-select mb-2" id="product-select">
            <option value="">-- Choose a product --</option>
          </select>
         
          <div id="size-qty" style="display:none">
            <label>Quantity by Size:</label>
            <div class="row g-2" id="size-options"></div>
            <button class="btn btn-custom mt-3" onclick ="addToCart()">Add to Cart</button>
          </div>
        </div>
      </div>

      <div class="col-md-6">
        <div class="card p-3">
          <h5>Cart</h5>
          <ul class="list-group mb-3" id="cart-list"></ul>
          <h6>Total: ₱<span id="total-price">0</span></h6>
          <button class="btn btn-success" onclick="checkout()">Checkout</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.0.0/dist/umd/supabase.min.js"></script>

  <script>
    const SUPABASE_URL = "https://dihzhshukgwduxatoyrj.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRpaHpoc2h1a2d3ZHV4YXRveXJqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE3NTExMzEsImV4cCI6MjA1NzMyNzEzMX0.EuyuH4VVV92bb44-x59rs9id5eSNA-CU6guMkCP74Vc"; 
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let products = [];
    let ownerId = null;
    const cart = [];

    async function getLoggedInUser() {
      const { data: { user }, error } = await supabase.auth.getUser();
      if (error) return console.error("Error fetching user:", error);
      if (user) {
        ownerId = user.id;
        fetchProducts();
      } else {
        console.log("User not logged in.");
      }
    }

    async function fetchProducts() {
      if (!ownerId) return console.error("Owner ID not found.");
      const { data, error } = await supabase
        .from('products')
        .select('id, name, price, size')
        .eq('owner_id', ownerId);

      if (error) return console.error('Error fetching products:', error);
      products = data;
      updateProductSelect();
    }

    function updateProductSelect() {
      const productSelect = document.getElementById('product-select');
      productSelect.innerHTML = '<option value="">-- Choose a product --</option>';
      products.forEach(product => {
        const option = document.createElement('option');
        option.value = product.id;
        option.textContent = `${product.name} - ₱${product.price}`;
        productSelect.appendChild(option);
      });
    }

    document.getElementById('product-select').addEventListener('change', function () {
      const selectedId = parseInt(this.value);
      const product = products.find(p => p.id === selectedId);
      const sizeContainer = document.getElementById('size-options');
      sizeContainer.innerHTML = '';
      document.getElementById('size-qty').style.display = 'none';

      if (product && product.size) {
        const sizes = product.size.split(',').map(s => s.trim());
        sizes.forEach(size => {
          const col = document.createElement('div');
          col.className = 'col-md-4';
          col.innerHTML = ` 
            <label>${size}</label>
            <input type="number" class="form-control" data-size="${size}" min="0" placeholder="Qty">
          `;
          sizeContainer.appendChild(col);
        });
        document.getElementById('size-qty').style.display = 'block';
      }
    });

    function addToCart() {
      const selectedId = parseInt(document.getElementById('product-select').value);
      const product = products.find(p => p.id === selectedId);
      if (!product) return alert("Select a product first.");

      const inputs = document.querySelectorAll('#size-options input');
      let somethingAdded = false;

      inputs.forEach(input => {
        const qty = parseInt(input.value);
        const size = input.getAttribute('data-size');
        if (qty && qty > 0) {
          cart.push({ product, size, quantity: qty });
          somethingAdded = true;
        }
      });

      if (!somethingAdded) return alert("Enter quantity for at least one size.");
      updateCartDisplay();
    }

    function updateCartDisplay() {
      const cartList = document.getElementById('cart-list');
      cartList.innerHTML = '';
      let total = 0;

      cart.forEach((item, index) => {
        const price = item.quantity * item.product.price;
        total += price;
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `
          ${item.product.name} (${item.size}) x ${item.quantity}
          <span>₱${price}</span>
          <button class="btn btn-sm btn-danger" onclick="removeCartItem(${index})">×</button>
        `;
        cartList.appendChild(li);
      });

      document.getElementById('total-price').textContent = total.toFixed(2);
    }

    function removeCartItem(index) {
      cart.splice(index, 1);
      updateCartDisplay();
    }

    async function checkout() {
  if (cart.length === 0) return alert("Cart is empty!");

  const { data: { user }, error: userError } = await supabase.auth.getUser();
  if (userError || !user) {
    alert("User not logged in. Cannot place order.");
    return;
  }

  const buyerId = user.id;
  const customerName = "Customer Name Here"; // Replace with actual customer name logic if needed
  const timestamp = new Date().toISOString();

  let totalOrderPrice = 0; // To calculate total price for the order

  for (let item of cart) {
    const { product, size, quantity } = item;
    const totalPricePerProduct = quantity * product.price;
    totalOrderPrice += totalPricePerProduct;

    const { error } = await supabase.from('orders').insert({
      product_id: product.id,
      product_name: product.name,
      price: product.price,
      size: size,
      quantity: quantity,
      customer_name: customerName, // Assuming customer_name is the buyer's name
      buyer_id: buyerId,
      owner_id: ownerId,
      total_price: totalOrderPrice, // Storing total price of the order
      status: 'pending',
      order_date: timestamp
    });

    if (error) {
      console.error("Error inserting order:", error);
      alert("Error placing order. Please try again.");
      return;
    }
  }

  alert("Order placed successfully!");
  cart.length = 0;
  updateCartDisplay();
}
    // Initialize the user and products
    getLoggedInUser();
  </script>
</body>
</html>
